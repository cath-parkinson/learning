---
title: "Opt_Theory"
output: html_document
date: "2024-07-25"
---

```{r libs}
library(tidyverse)
```
```{r curves}
neg_exp_curve <- function(x, alpha, beta) {
  val <- beta*(1 - exp(-x/alpha))
  return(val)
}

neg_exp_deriv <- function(x, alpha, beta) {
  val <- (beta/alpha)*exp(-x/alpha)
  return(val)
}

s_curve <- function(x, alpha, beta, gam) {
  val <- beta*x^alpha/(x^alpha + gam^alpha)
  return(val)
}

s_deriv <- function(x, alpha, beta, gam) {
  val <- alpha*beta*(gam^alpha)*x^(alpha-1)/(x^alpha + gam^alpha)^2
  return(val)
}

s_deriv2 <- function(x, alpha, beta, gam) {
  val <- alpha*beta*(gam^alpha)*(x^(alpha-2))*((alpha-1)*(gam^alpha)-(alpha+1)*(x^alpha))/(x^alpha + gam^alpha)^3
  return(val)
}

s_inflection_point <- function(alpha, gam) {
  infl <- (((alpha - 1)/(alpha + 1))^(1/alpha))*gam
  return(infl)
}
```


# The basics: fundamental curves and the target function

We seek to maximise the following function $f(\mathbf{x})$:

\[
f(\mathbf{x}) = \sum_{i=1}^{N} f_i(x_i)
\]

where $N = n + m$; $n, m \in \mathbb{N}$;
$\mathbf{x} = (x_1, x_2, ..., x_N)^{T} \in \mathbb{R}^N$, $x_i \geq 0$ for
$i = 1, 2, ..., N$; and $f_i : \mathbb{R}^+_0 \to \mathbb{R}^+_0$ take one of
two functional forms. For $i = 1, 2, ... , n$, the $f_i(x)$ are "negative 
exponential curves":

\[
f_i(x) = \beta_i\left(1 - \exp\left(-\frac{x}{\alpha_i}\right)\right)
\]

whereas for $i = n+1, n+2, ..., N = n+m$, they are "S-curves" of the form:

\[
f_i(x) = \frac{\beta_ix^{\alpha_i}}{\left(x^{\alpha_i} + \gamma_i^{\alpha_i}\right)}
\]

where the constants $\alpha_i, \beta_i \in \mathbb{R}^+$ for $i = 1, 2, ..., N$; and 
$\gamma_i \in \mathbb{R}^+$ for $i = n+1, n+2, ..., N$.

Thus we have:

\[
f(\mathbf{x}) = \beta_1\left(1 - \exp\left(-\frac{x}{\alpha_1}\right)\right) +
\dots + \beta_n\left(1 - \exp\left(-\frac{x}{\alpha_n}\right)\right) +
\frac{\beta_{n+1}x^{\alpha_{n+1}}}{\left(x^{\alpha_{n+1}} + \gamma_{n+1}^{\alpha_{n+1}}\right)} + \dots +
\frac{\beta_{n+m}x^{\alpha_{n+m}}}{\left(x^{\alpha_{n+m}} + \gamma_{n+m}^{\alpha_{n+m}}\right)}
\]

Each $f_i(x_i)$ represents the return obtained by investing an amount $x_i$ in
the $i^{th}$ _allocation unit_. For a given choice of constants we can visualise
the $f_i$ by plotting the curve $y = f_i(x)$.

For example, let us plot the negative exponential curves with
$\beta = 2$ and $\alpha = 1, 2, 3$.

```{r example_neg_exp_constants}
alpha_eg <- c(1, 2, 3)
beta_eg <- 2
```
```{r plot_neg_exp}
ggplot() +
  xlim(0, 10) +
  ylim(0, beta_eg*1.25) +
  geom_hline(yintercept = beta_eg,
             linetype = "dashed") +
  geom_function(fun = ~ neg_exp_curve(x = .x,
                                      alpha = alpha_eg[1],
                                      beta = beta_eg),
                aes(col = paste0(alpha_eg[1]))) +
  geom_function(fun = ~ neg_exp_curve(x = .x,
                                      alpha = alpha_eg[2],
                                      beta = beta_eg),
                aes(col = paste0(alpha_eg[2]))) +
  geom_function(fun = ~ neg_exp_curve(x = .x,
                                      alpha = alpha_eg[3],
                                      beta = beta_eg),
                aes(col = paste0(alpha_eg[3]))) +
  scale_colour_manual(values = c("royalblue1", "royalblue3", "royalblue4"),
                      name = "alpha") +
  xlab("x") +
  ylab("f") +
  theme_linedraw()
```
Note that the curves are all monotonic increasing, with horizontal asymptote at
$f(x) = \beta = 2$, and that the higher the value of $\alpha$, the shallower the
gradient at any given value of $x$.

The derivative of the negative exponential function $f_i, i = 1,2,...,n$ is
given by:

\[
f_i^{\prime}(x) = \frac{\beta_i}{\alpha_i}\exp\left(-\frac{x}{\alpha_i}\right)
\]

Below are plotted the derivatives of the three example curves above.

```{r plot_neg_exp_deriv}
ggplot() +
  xlim(0, 10) +
  ylim(0, 1.25) +
  geom_function(fun = ~ neg_exp_deriv(x = .x,
                                      alpha = alpha_eg[1],
                                      beta = beta_eg),
                aes(col = paste0(alpha_eg[1]))) +
  geom_function(fun = ~ neg_exp_deriv(x = .x,
                                      alpha = alpha_eg[2],
                                      beta = beta_eg),
                aes(col = paste0(alpha_eg[2]))) +
  geom_function(fun = ~ neg_exp_deriv(x = .x,
                                      alpha = alpha_eg[3],
                                      beta = beta_eg),
                aes(col = paste0(alpha_eg[3]))) +
  scale_colour_manual(values = c("darkorange2", "darkorange3", "darkorange4"),
                      name = "alpha") +
  xlab("x") +
  ylab("f'") +
  theme_linedraw()
```
Note that the derivative is monotonic decreasing, starting at it's highest
value $\frac{\beta_i}{\alpha_i}$ at $x = 0$.

Next we plot some example S-curves, i.e. $f_i, i = n+1, ... ,n+m$. We will again
fix $\beta = 2$, since this constant simply stretches the curve vertically.
First, consider the family of three curves with $\gamma = 3$, and
$\alpha = 2,3,4$.

```{r s_constants_1}
alpha_eg <- c(2, 3, 4)
beta_eg <- 2
gam_eg <- 3
```
```{r plot_s_1}
ggplot() +
  xlim(0, 10) +
  ylim(0, beta_eg*1.25) +
  geom_hline(yintercept = beta_eg,
             linetype = "dashed") +
  geom_function(fun = ~ s_curve(x = .x,
                                alpha = alpha_eg[1],
                                beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[1]))) +
  geom_function(fun = ~ s_curve(x = .x,
                                      alpha = alpha_eg[2],
                                      beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[2]))) +
  geom_function(fun = ~ s_curve(x = .x,
                                      alpha = alpha_eg[3],
                                      beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[3]))) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[1],
                                    gam = gam_eg),
             y = s_curve(x = s_inflection_point(alpha = alpha_eg[1],
                                    gam = gam_eg),
                         alpha = alpha_eg[1],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "royalblue1", shape = 5) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[2],
                                    gam = gam_eg),
             y = s_curve(x = s_inflection_point(alpha = alpha_eg[2],
                                    gam = gam_eg),
                         alpha = alpha_eg[2],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "royalblue3", shape = 5) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[3],
                                    gam = gam_eg),
             y = s_curve(x = s_inflection_point(alpha = alpha_eg[3],
                                    gam = gam_eg),
                         alpha = alpha_eg[3],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "royalblue4", shape = 5) +
  scale_colour_manual(values = c("royalblue1", "royalblue3", "royalblue4"),
                      name = "alpha") +
  xlab("x") +
  ylab("f") +
  theme_linedraw()
```
Note that again the functions are monotonic increasing, with asymptote at
$f(x) = \beta = 2$. The "S" shape corresponds with a point of inflection where
the gradient changes from increasing to decreasing - these points are marked on
each curve above. As $\alpha$ increases, the "S" shape becomes "sharper" - with
higher values of $\alpha$ giving both smaller gradients for small $x$, and larger
maximum gradients at the inflection point.

The derivative of the S-curve function is

\[
f_i^{\prime}(x) = \frac{\alpha_i\beta_i\gamma_i^{\alpha_i}x^{\alpha_i - 1}}{\left(x^{\alpha_i}+{\gamma_i}^{\alpha_i}\right)^2}
\]

Below are plotted the derivatives of the three example S-curves above.

```{r plot_s_1_deriv}
ggplot() +
  xlim(0, 10) +
  ylim(0, 1) +
  geom_vline(xintercept = gam_eg,
             linetype = "dashed") +
  annotate("text",
           label = "gamma",
           x = gam_eg*1.05,
           y = 0.97,
           size = 4,
           parse = TRUE) +
  geom_function(fun = ~ s_deriv(x = .x,
                                alpha = alpha_eg[1],
                                beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[1]))) +
  geom_function(fun = ~ s_deriv(x = .x,
                                      alpha = alpha_eg[2],
                                      beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[2]))) +
  geom_function(fun = ~ s_deriv(x = .x,
                                      alpha = alpha_eg[3],
                                      beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[3]))) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[1],
                                    gam = gam_eg),
             y = s_deriv(x = s_inflection_point(alpha = alpha_eg[1],
                                    gam = gam_eg),
                         alpha = alpha_eg[1],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "darkorange2", shape = 5) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[2],
                                    gam = gam_eg),
             y = s_deriv(x = s_inflection_point(alpha = alpha_eg[2],
                                    gam = gam_eg),
                         alpha = alpha_eg[2],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "darkorange3", shape = 5) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[3],
                                    gam = gam_eg),
             y = s_deriv(x = s_inflection_point(alpha = alpha_eg[3],
                                    gam = gam_eg),
                         alpha = alpha_eg[3],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "darkorange4", shape = 5) +
  scale_colour_manual(values = c("darkorange2", "darkorange3", "darkorange4"),
                      name = "alpha") +
  xlab("x") +
  ylab("f") +
  theme_linedraw()
```
The plot again shows the location of the inflection points of the S-curves,
i.e. where the derivative has a stationary point. Note that the inflection point
is located at an x value less than $\gamma$.

The second derivative of the S-curve function is

\[
f_i^{\prime\prime}(x) = \frac{\alpha_i\beta_i\gamma_i^{\alpha_i}x^{\alpha_i - 2}\left(\left(\alpha_i-1\right)\gamma_i^{\alpha_i} - \left(\alpha_i+1\right)x^{\alpha_i}\right)}{\left(x^{\alpha_i}+{\gamma_i}^{\alpha_i}\right)^3}
\]

Below are plotted the second derivatives of the example S-curves above.

```{r plot_s_1_deriv2}
ggplot() +
  xlim(0, 10) +
  ylim(-1, 1) +
  geom_vline(xintercept = gam_eg,
             linetype = "dashed") +
  annotate("text",
           label = "gamma",
           x = gam_eg*1.05,
           y = 0.97,
           size = 4,
           parse = TRUE) +
  geom_function(fun = ~ s_deriv2(x = .x,
                                alpha = alpha_eg[1],
                                beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[1]))) +
  geom_function(fun = ~ s_deriv2(x = .x,
                                      alpha = alpha_eg[2],
                                      beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[2]))) +
  geom_function(fun = ~ s_deriv2(x = .x,
                                      alpha = alpha_eg[3],
                                      beta = beta_eg,
                                gam_eg),
                aes(col = paste0(alpha_eg[3]))) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[1],
                                    gam = gam_eg),
             y = s_deriv2(x = s_inflection_point(alpha = alpha_eg[1],
                                    gam = gam_eg),
                         alpha = alpha_eg[1],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "darkorchid2", shape = 5) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[2],
                                    gam = gam_eg),
             y = s_deriv2(x = s_inflection_point(alpha = alpha_eg[2],
                                    gam = gam_eg),
                         alpha = alpha_eg[2],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "darkorchid3", shape = 5) +
  geom_point(aes(x = s_inflection_point(alpha = alpha_eg[3],
                                    gam = gam_eg),
             y = s_deriv2(x = s_inflection_point(alpha = alpha_eg[3],
                                    gam = gam_eg),
                         alpha = alpha_eg[3],
                         beta = beta_eg,
                         gam = gam_eg)),
             size = 1, colour = "darkorchid4", shape = 5) +
  scale_colour_manual(values = c("darkorchid2", "darkorchid3", "darkorchid4"),
                      name = "alpha") +
  xlab("x") +
  ylab("f") +
  theme_linedraw()
```

Note that this clearly shows the inflection points as zeroes of the second
derivative appearing at values slightly less than $\gamma$. The inflection point
is located at

\[
x\bigg\vert_{f^{\prime\prime}=0}=\left(\frac{\alpha-1}{\alpha+1}\right)^{\frac{1}{\alpha}}\gamma
\]

This formula clearly shows the inflection point approaching $\gamma$ from below
as $\alpha$ increases. This is also demonstrated in the graph above.

# An example objective function

Let us consider an example objective function comprising one negative
exponential curve and one S-curve:

\[
f\left(x_1,x_2\right) = 2\left(1-\exp\left(-x_1/4\right)\right) + \frac{3}{1+\left(\frac{5}{x_2}\right)^6}
\]

this is equivalent to the above general form of $f(\mathbf{x})$ with: $n=1$, $m=1$ (and therefore $N=2$); $\alpha_1=4$, $\beta_1=2$, $\alpha_2=6$, $\beta_2=3$, $\gamma_2 = 5$.

```{r example-f-consts}
beta_x <- 2
alpha_x <- 4

beta_y <- 3
gamma_y <- 5
alpha_y <- 6
```

```{r example-f}
f <- function(x, y) {beta_x * (1 - exp(-x/alpha_x)) + beta_y * (1/(1+(gamma_y/y)^alpha_y))}
```

```{r plot-grid}
x <- seq(0, 10, length.out = 100)
y <- seq(0, 10, length.out = 100)
```

We can visualise this objective function plotting it as a surface as below.

```{r plot-example-grid}
library(plotly)
scene = list(camera = list(eye = list(x = -1.5*1.2, y = -1.75*1.2, z = 0.75*1.2)))

plotly::plot_ly(x = x, y = y,
        z = outer(x, y, f),
        type = "surface") %>% 
  layout(scene = scene)
```


# The budget constraint

Maximising $f(\mathbf{x})$ without any constraints on $\mathbf{x}$ simply
results in $x_i \to \infty$, $i = 1,2,\dots,N$. In reality we have a finite
"budget", constraining $\mathbf{x}$ as follows:

\[
\sum_{i=1}^{N}x_i = T \gt 0
\]

Continuing the example objective function from the above section, consider this
objective with a budget of $T = 10$. By substituting $x_1 = 10 - x_2$ into
$f(\mathbf{x})$, we can look at how the objective varies as the budget is
allocated across the two variables $x_1$ and $x_2$.

```{r example-constrained-f-1}
budget <- 10

ggplot(data.frame(x = x),aes(x)) +
  xlim(0, budget) +
  geom_function(fun = ~ f(budget - .x, .x)) +
  geom_vline(xintercept = budget) +
  theme_linedraw() +
  xlab("x2") +
  ylab("f")
```
Clearly the maximum occurs at the local maximum just below $x_2 = 7.5$. Now
consider the same problem with a budget $T=6$.

```{r example-constrained-f-2}
budget <- 6

ggplot(data.frame(x = x),aes(x)) +
  xlim(0, budget) +
  geom_function(fun = ~ f(budget - .x, .x)) +
  geom_vline(xintercept = budget) +
  theme_linedraw() +
  xlab("x2") +
  ylab("f")
```

Now it is clear that the maximum (2.25) is attained on the right-hand edge of
the range at $x_2 = 6$. Note that the local _minimum_ in the centre means that
there may be a risk of numerical algorithms "climbing" the slope to the left
towards $x_2 = 0$, especially with starting values below the local minimum. An
even more extreme example of this is seen with $T=5$.

```{r example-constrained-f-3}
budget <- 5

ggplot(data.frame(x = x),aes(x)) +
  xlim(0, budget) +
  geom_function(fun = ~ f(budget - .x, .x)) +
  geom_vline(xintercept = budget) +
  theme_linedraw() +
  xlab("x2") +
  ylab("f")
```

Here, the objective functions has a fairly similar value for either end of the
range $x_2=0$ and $x_2=5$.

These examples illustrate that even with the simplest possible example objective
and only one constraint, the optimisation problem exhibits the challenging
feature of multiple local or "edge" maxima.



